package practicaTree;
import java.awt.*;
import java.net.*;
import java.sql.*;
import java.util.*;
import javax.swing.*;
import javax.swing.tree.*;

public class PantallaUno extends JFrame{
	private static final long serialVersionUID = 1L;
	private JLabel ipServidor, usuario, contrasena, defaultSchema, puerto;
	private JTextField cuadroIpServidor, cuadroUsuario, cuadroContrasena, cuadroDefaultSchema, cuadroPuerto;
	private JButton btConectar, btDesconectar;
	private JLabel etiqueta;
	private Modelo modelo;
	
	protected Connection conexion;
	protected Statement statement;
	protected DatabaseMetaData dataBaseMetaData;
	DefaultTreeModel model;
	private static DefaultMutableTreeNode root;
	
	private JPanel panel1, panel2;
	
	public static void main(String[] args) {
		new PantallaUno();
	}
	public PantallaUno() {
		super("Practica BASE DE DATOS");
		crearInterfaz();
	}
	public void crearInterfaz() {
		System.out.println("Creando Interfaz PantallaUno...");
		
		setLayout(new FlowLayout(FlowLayout.CENTER));
		panel1=new JPanel();
		panel1.setLayout(new GridLayout(7,7));
		
		ipServidor=new JLabel("IP Servidor Base Datos");
		usuario=new JLabel("Usuario");
		contrasena=new JLabel("ContraseÃ±a");
		defaultSchema=new JLabel("Default Schema");
		puerto=new JLabel("Puerto");
		cuadroIpServidor=new JTextField("localhost");
		cuadroUsuario=new JTextField("root");
		cuadroContrasena=new JTextField("mysql");
		cuadroDefaultSchema=new JTextField("bdgestion");
		cuadroPuerto=new JTextField("3306");
		btConectar=new JButton("Conectar");
		btDesconectar=new JButton("Desconectar");
		etiqueta=new JLabel();
		
		panel1.add(ipServidor);
		panel1.add(cuadroIpServidor);
		panel1.add(usuario);
		panel1.add(cuadroUsuario);
		panel1.add(contrasena);
		panel1.add(cuadroContrasena);
		panel1.add(defaultSchema);
		panel1.add(cuadroDefaultSchema);
		panel1.add(puerto);
		panel1.add(cuadroPuerto);
		panel1.add(btConectar);
		panel1.add(btDesconectar);
		
		add(panel1);
		
		ImageIcon icono2=obtenerImagen("../imagenes/off.png","Indicador OFF");
		etiqueta.setIcon(icono2);
		panel1.add(etiqueta);
		
		btConectar.addActionListener(e->{
			try {
				
				System.out.println("Conectando...");
				
				ImageIcon icono=obtenerImagen("../imagenes/on.png","Indicador ON");
				etiqueta.setIcon(icono);
				panel1.add(etiqueta);
				panel2=new JPanel();
				panel2.setLayout(new FlowLayout());
				add(panel2);
				//indicador verde
				modelo=new Modelo(cuadroIpServidor.getText(),cuadroUsuario.getText(),cuadroContrasena.getText(),cuadroDefaultSchema.getText(),cuadroPuerto.getText());
				conexion();
				System.out.println(modelo);
				
				//PruebaDos vd=new PruebaDos(modelo);
				crearEstructura();
			} catch (SQLException e1) {
				System.out.println(e1.getMessage());
			}
		});
		btDesconectar.addActionListener(e->{
			System.out.println("Desconectando...");
			etiqueta.setIcon(icono2);
			panel1.add(etiqueta);
			panel2.removeAll();
			panel2.add(new JTextField("Sin Conexion :("));
			//indicador rojo
		});
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		
		
		
		setSize(680,680);
		setVisible(true);
	}
	public JScrollPane getScroll() throws SQLException{

		root=new DefaultMutableTreeNode("ROOT");
		
		model=new DefaultTreeModel(root);
		JTree arbol=new JTree(model);
		arbol.setRootVisible(true);
		for(String tabla:getTablas(modelo.cuadroDefaultSchema)) {
			System.out.println("Tabla: "+tabla);
			cargarEstructura(tabla);
		}

		JScrollPane scroll=new JScrollPane(arbol);
		return scroll;
	}
	public void crearEstructura() {

		root=new DefaultMutableTreeNode("ROOT");
		
		model=new DefaultTreeModel(root);
		
		JTree arbol=new JTree(model);
		arbol.setRootVisible(true);
		try {
			for(String tabla:getTablas(modelo.cuadroDefaultSchema)) {
				System.out.println("Tabla: "+tabla);
				cargarEstructura(tabla);
			}
		} catch (SQLException e) {
			System.out.println("No obtiene las tablas");
		}

		JScrollPane scroll=new JScrollPane(arbol);
		getContentPane().add(scroll);
		panel2.add(scroll);
	}
	public void cargarEstructura(String nombreTabla) {
		
		DefaultMutableTreeNode nodoHijo=new DefaultMutableTreeNode(nombreTabla);
		for(String columnastipos:getColumnasTipos(modelo.cuadroDefaultSchema, nombreTabla)) {
			DefaultMutableTreeNode columnasTipos=new DefaultMutableTreeNode(columnastipos);
			nodoHijo.add(columnasTipos);
		}
		
		root.add(nodoHijo);
		
	}
	public void conexion() throws SQLException {
		System.out.println("Creando Conexion...");
		String url="jdbc:mysql://localhost:3306/"+modelo.cuadroDefaultSchema;
		try {
			Class.forName("com.mysql.jdbc.Driver");
			conexion=DriverManager.getConnection(url,modelo.cuadroUserName,modelo.cuadroPassword);
			statement=conexion.createStatement();
			dataBaseMetaData=conexion.getMetaData();
		}catch (ClassNotFoundException e) {
			System.out.println(e.getMessage());
		}catch (SQLException e) {
			System.out.println(e.getMessage());
		}
		System.out.println("Se Ha Conectado...");
	}
	
	public ArrayList<String> getTablas(String nombreEsquema) throws SQLException{
		ArrayList<String> arrayTablas=new ArrayList<>();
		System.out.println("getTablas() "+nombreEsquema);
		String catalogo=null;
		String patronTabla="%";
		String[] tipos=null;
		ResultSet tablas=dataBaseMetaData.getTables(nombreEsquema, catalogo,  patronTabla, tipos);
		String nombreTabla=null;
		while(tablas.next()) {
			nombreTabla=tablas.getString(3);
			System.out.println(nombreTabla);
			arrayTablas.add(nombreTabla);
		}
		System.out.println("Fin getTablas()");
		return arrayTablas;
	}
	
	public ArrayList<String> getColumnasTipos(String nombreEsquema, String tablas) {
		System.out.println("getColumnasTipos()");
		
		ArrayList columnasTipos=new ArrayList();
		//String nombreEsquema=modelo.cuadroDefaultSchema;
		try {
			dataBaseMetaData=conexion.getMetaData();
			String catalogo=null;
			String formatoCol=null;
		
				ResultSet rsColumnasTipos=dataBaseMetaData.getColumns(nombreEsquema, catalogo, tablas, formatoCol);
				String columna, tipo;
				while(rsColumnasTipos.next()){
					columna=rsColumnasTipos.getString(4);
					tipo=rsColumnasTipos.getString(6);
					System.out.println("Columna: "+columna);
					System.out.println("Tipo: "+tipo);
					columnasTipos.add(columna+" "+tipo.toUpperCase());
				}
			
		}catch (SQLException e1) {
			System.out.println(e1.getMessage());
		}
		return columnasTipos;
	}
	private ImageIcon obtenerImagen(String ruta, String descripcion) {
		URL imgUrl=getClass().getResource(ruta);
		if(imgUrl!=null) {
			return new ImageIcon(imgUrl, descripcion);
		}
		else {
			System.err.println("No ha encontrado imagen en "+ruta);
			return null;
		}
	}
	public class Modelo{
		protected String cuadroServerHost=null;
		protected String cuadroUserName=null;
		protected String cuadroPassword=null;
		protected String cuadroDefaultSchema =null;
		protected String cuadroPort=null;
		/*public Modelo() {
			this("n/a","n/a","n/a","n/a","n/a");
		}*/
		public Modelo(String cuadroServerHost, String cuadroUserName, String cuadroPassword, String cuadroDefaultSchema, String cuadroPort) {
			this.cuadroServerHost=cuadroServerHost;
			this.cuadroUserName=cuadroUserName;
			this.cuadroPassword=cuadroPassword;
			this.cuadroDefaultSchema=cuadroDefaultSchema;
			this.cuadroPort=cuadroPort;
			System.out.println("Creando Modelo...");
		}
		@Override
		public String toString() {
			return "Modelo [cuadroServerHost=" + cuadroServerHost + ", cuadroUserName=" + cuadroUserName
					+ ", cuadroPassword=" + cuadroPassword + ", cuadroDefaultSchema=" + cuadroDefaultSchema
					+ ", cuadroPort=" + cuadroPort + "]";
		}
	}
}

